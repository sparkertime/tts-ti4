MECATOL_GUID = "04df02"

TILE_CUTOFF_X = 5.25

RESOURCE_TILES = {
  {
    guid = "4216fd",
    key = "19",
    planets = {"Wellon"},
    resources = 1,
    influence = 2,
    skips = {yellows = 1},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "bc4bcc",
    key = "20",
    planets = {"Vefut II"},
    resources = 2,
    influence = 2,
    skips = {},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "f2798a",
    key = "21",
    planets = {"Thibah"},
    resources = 1,
    influence = 1,
    skips = {blues = 1},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "0ea77f",
    key = "22",
    planets = {"Tar'Mann"},
    resources = 1,
    influence = 1,
    skips = {greens = 1},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "7975f7",
    key = "23",
    planets = {"Saudor"},
    resources = 2,
    influence = 2,
    skips = {},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "48cc9f",
    key = "24",
    planets = {"Mehar Xull"},
    resources = 1,
    influence = 3,
    skips = {reds = 1},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "71e1bf",
    key = "25",
    planets = {"Quann"},
    resources = 2,
    influence = 1,
    skips = {},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "f11ef5",
    key = "26",
    planets = {"Lodor"},
    resources = 3,
    influence = 1,
    skips = {},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "fc239f",
    key = "27",
    planets = {"New Albion", "Starpoint"},
    resources = 4,
    influence = 2,
    skips = {greens = 1},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "f8caf6",
    key = "28",
    planets = {"Tequ'Ran", "Torkan"},
    resources = 2,
    influence = 3,
    skips = {},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "0ac98b",
    key = "29",
    planets = {"Qucen'n", "Rarron"},
    resources = 1,
    influence = 5,
    skips = {},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "aaae9f",
    key = "30",
    planets = {"Mellon", "Zohbat"},
    resources = 3,
    influence = 3,
    skips = {},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "d5ed63",
    key = "31",
    planets = {"Lazar", "Sakulag"},
    resources = 3,
    influence = 1,
    {yellows = 1},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "48ac87",
    key = "32",
    planets = {"Dal Bootha", "XXehan"},
    resources = 1,
    influence = 3,
    skips = {},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "87a5a2",
    key = "33",
    planets = {"Corneeq", "Resculon"},
    resources = 3,
    influence = 2,
    skips = {},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "eb99c0",
    key = "34",
    planets = {"Centauri", "Gral"},
    resources = 2,
    influence = 4,
    skips = {blues = 1},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "dd2ca7",
    key = "35",
    planets = {"Bereg", "Lirta IV"},
    resources = 5,
    influence = 4,
    skips = {},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "a284d1",
    key = "36",
    planets = {"Arnor", "Lor"},
    resources = 3,
    influence = 3,
    skips = {},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "e0ff33",
    key = "37",
    planets = {"Arinam", "Meer"},
    resources = 1,
    influence = 6,
    skips = {reds = 1},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "b958aa",
    key = "38",
    planets = {"Abyz", "Fria"},
    resources = 5,
    influence = 0,
    skips = {},
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "0378a4",
    key = "39",
    influence = 0,
    resources = 0,
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "ccd7ac",
    key = "40",
    influence = 0,
    resources = 0,
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "47a55d",
    key = "41",
    influence = 0,
    resources = 0,
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "d13aa2",
    key = "42",
    influence = 0,
    resources = 0,
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "dca098",
    key = "43",
    influence = 0,
    resources = 0,
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "cd58c7",
    key = "44",
    influence = 0,
    resources = 0,
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "7db8d8",
    key = "45",
    influence = 0,
    resources = 0,
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "9dce5a",
    key = "46",
    influence = 0,
    resources = 0,
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "437f06",
    key = "47",
    influence = 0,
    resources = 0,
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "ff8f60",
    key = "48",
    influence = 0,
    resources = 0,
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "0216be",
    key = "49",
    influence = 0,
    resources = 0,
    cultural = 0,
    industrial = 0,
    hazardous = 0
  },
  {
    guid = "97ee53",
    key = "50",
    influence = 0,
    resources = 0,
    cultural = 0,
    industrial = 0,
    hazardous = 0
  }
}

HOME_SYSTEM_GUIDS = {"b11803", "3b501b", "9c373a", "9dcc89", "953f0f", "4fd9eb"}

LABELS = {}
LABEL_NAME = 'AUTOBALANCER_LABEL'

function onLoad()
  clearAllText()
  findBalance()
end

function onObjectDrop(colorName, obj)
  Wait.time(function()
    clearText()
    findBalance()
  end, 0.5)
end

function getHomeSystemsInPlay()
  local homes = {}

  for _, homeGUID in ipairs(HOME_SYSTEM_GUIDS) do
    local homeObject = getObjectFromGUID(homeGUID)

    if homeObject.getPosition().x < TILE_CUTOFF_X then
      table.insert(homes, {
        object = homeObject,
        name = homeObject.getName(),
        homeSlice = {
          resources = 0,
          influence = 0,
          blues = 0,
          reds = 0,
          yellows = 0,
          greens = 0,
          cultural = 0,
          industrial = 0,
          hazardous = 0
        },
        total = {
          resources = 0,
          influence = 0,
          blues = 0,
          reds = 0,
          yellows = 0,
          greens = 0,
          cultural = 0,
          industrial = 0,
          hazardous = 0
        }
      })
    end
  end

  return homes
end

function getNonHomeSystemsInPlay()
  local systemsInPlay = {}
  
  for _, tile in ipairs(RESOURCE_TILES) do
    local tileObject = getObjectFromGUID(tile.guid)

    if tileObject.getPosition().x < TILE_CUTOFF_X then
      table.insert(systemsInPlay, {
        object = tileObject,
        tile = tile
      })
    end
  end

  return systemsInPlay
end

ROUNDING = 2.5
function findClosestHomeSystems(targetSystem, homesInPlay)
  local closestHomes = {}

  local targetTilePosition = targetSystem.object.getPosition()
  local shortestDistance = 100000;

  for _, home in ipairs(homesInPlay) do
    local homePosition = home.object.getPosition()
    local deltaX = targetTilePosition.x - homePosition.x
    local deltaZ = targetTilePosition.z - homePosition.z
    local distance = math.sqrt(deltaX * deltaX + deltaZ * deltaZ)

    if shortestDistance - distance > ROUNDING then
      closestHomes = { home }
      shortestDistance = distance
    elseif math.abs(distance - shortestDistance) <= ROUNDING then
      table.insert(closestHomes, home)
      shortestDistance = math.min(shortestDistance, distance)
    end
  end

  return closestHomes
end

function addToCount(counterTable, tile, divisor)
  local skips = tile.skips or {}

  counterTable.resources = counterTable.resources + (tile.resources / divisor)
  counterTable.influence = counterTable.influence + (tile.influence / divisor)
  counterTable.industrial = counterTable.industrial + (tile.industrial / divisor)
  counterTable.hazardous = counterTable.hazardous + (tile.hazardous / divisor)
  counterTable.cultural = counterTable.cultural + (tile.cultural / divisor)
  counterTable.blues = counterTable.blues + ((skips.blues or 0) / divisor)
  counterTable.yellows = counterTable.yellows + ((skips.yellows or 0) / divisor)
  counterTable.reds = counterTable.reds + ((skips.reds or 0) / divisor)
  counterTable.greens = counterTable.greens + ((skips.greens or 0) / divisor)
end

function clearAllText()
  for _, obj in ipairs(getAllObjects()) do
    if obj.getName() == LABEL_NAME then
	    destroyObject(obj)
    end
  end
end

function clearText()
  for _, label in ipairs(LABELS) do
    destroyObject(label)
  end

  LABELS = {}
end

function writeTextAbove(tileObject, baseRotation, text)
  local tilePosition = tileObject.getPosition()

  local textObject = spawnObject({
    type = "3DText",
    position = {
      x = tilePosition.x,
      y = tilePosition.y + 0.25,
      z = tilePosition.z - 1.1
    },
    rotation = {
      x = baseRotation.x + 90,
      y = baseRotation.y + 180,
      z = baseRotation.z
    }
  })

  textObject.TextTool.setValue(text)
  textObject.setName(LABEL_NAME)
  table.insert(LABELS, textObject)
end

COLORS = {
  {name = "reds", abbreviation = "R"},
  {name = "greens", abbreviation = "G"},
  {name = "blues", abbreviation = "B"},
  {name = "yellows", abbreviation = "Y"}
}

function formatSliceText(slice)
  local techText = ""

  for _, color in ipairs(COLORS) do
    if slice[color.name] then
      if #techText > 0 then
        techText = techText .. " "
      end

      techText = techText .. formatNumber(slice[color.name]) .. color.abbreviation
    end
  end

  return homeSystem.homeSlice.resources ..
    "/" ..
    homeSystem.homeSlice.influence ..
    ((#techText > 0) and (" " .. techText) or "")
end

function formatNumber(number)
  local str = string.format("%.1f", number)
  return string.gsub(str, "%.0","")
end

function findBalance()
  local mecatol = getObjectFromGUID(MECATOL_GUID)
  if mecatol == nil then
    broadcastToAll("Unable to find Mecatol Rex, ensure that it has not been deleted.")
    return
  end

  local homeSystemsInPlay = getHomeSystemsInPlay()

  for _, system in ipairs(getNonHomeSystemsInPlay()) do
    local closestHomes = findClosestHomeSystems(system, homeSystemsInPlay)

    for _, homeSystem in ipairs(closestHomes) do
      if #closestHomes == 1 then
        addToCount(homeSystem.homeSlice, system.tile, 1)
      end
      addToCount(homeSystem.total, system.tile, #closestHomes)
    end
  end

  for _, homeSystem in ipairs(homeSystemsInPlay) do
    writeTextAbove(homeSystem.object, mecatol.getRotation(),
      homeSystem.name ..
      "\n" ..
      homeSystem.homeSlice.resources ..
      "/" ..
      homeSystem.homeSlice.influence ..
      " " ..
      ((homeSystem.homeSlice.blues > 0) and (homeSystem.homeSlice.blues .. "B") or "") ..
      ((homeSystem.homeSlice.yellows > 0) and (homeSystem.homeSlice.yellows .. "Y") or "") ..
      ((homeSystem.homeSlice.reds > 0) and (homeSystem.homeSlice.reds .. "R") or "") ..
      ((homeSystem.homeSlice.greens > 0) and (homeSystem.homeSlice.greens .. "G") or "") ..
      "\n" ..
      formatNumber(homeSystem.total.resources) ..
      "/" ..
      formatNumber(homeSystem.total.influence) ..
      " " ..
      ((homeSystem.total.blues > 0) and (formatNumber(homeSystem.total.blues) .. "B") or "") ..
      ((homeSystem.total.yellows > 0) and (formatNumber(homeSystem.total.yellows) .. "Y") or "") ..
      ((homeSystem.total.reds > 0) and (formatNumber(homeSystem.total.reds) .. "R") or "") ..
      ((homeSystem.total.greens > 0) and (formatNumber(homeSystem.total.greens) .. "G") or "")
    )
  end
end